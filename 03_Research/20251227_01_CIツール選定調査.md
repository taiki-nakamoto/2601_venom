# CI/CDツール選定調査

## 概要

本ドキュメントは、CI/CDツールの選定に関する調査結果をまとめたものです。特に、Woodpecker CIを採用した背景と、他のCI/CDツールとの比較を整理しています。

**調査日**: 2025年12月27日

**調査目的**:
- 主要CI/CDツールの特徴と分類を整理
- AWS連携を前提としたツール選定の判断基準を明確化
- セルフホスト型ツールの運用コストと自由度のトレードオフを理解

## 1. 主要CI/CDツールの比較・分類

各ツールは「運用コスト」と「自由度」のトレードオフで整理できます。

| カテゴリ | ツール名 | 管理・運用 | 設定形式 | 特徴・強み |
|---|---|---|---|---|
| SaaS型 (標準) | CircleCI | 不要 (お任せ) | YAML | 爆速・多機能。SSHデバッグ、ローカルCLIが非常に強力。 |
| SaaS型 (統合) | GitHub Actions | 不要 (お任せ) | YAML | GitHubとの親和性が最高。マーケットプレイスが豊富。 |
| オールインワン | GitLab | 高い (自前可) | YAML | コード管理〜セキュリティまで全部入り。重いが多機能。 |
| 伝統的OSS | Jenkins | 非常に高い | Groovy | 無限の拡張性。独自の秘伝のタレを作れるが保守が大変。 |
| 軽量コンテナ型 | Drone / Woodpecker | 低い (自前) | YAML | 超軽量。全ステップがDocker。低スペックEC2でも動く。 |

### 分類の観点

**SaaS型 (フルマネージド)**:
- メリット: インフラ管理不要、高速、スケーラブル
- デメリット: コスト、外部依存、カスタマイズ制限

**セルフホスト型 (自前運用)**:
- メリット: 完全な制御、コスト最適化、社内環境に閉じられる
- デメリット: 運用負荷、セキュリティ管理、スケーリング対応

## 2. CircleCI vs 他ツールの決定的な違い

CircleCIを選ぶ最大のメリットは、開発者の**「待ち時間」と「試行錯誤」のストレスを減らす仕組み**にあります。

### CircleCIの主要機能

**SSHデバッグ**:
- 失敗したジョブのコンテナに直接SSHで入り、その場で原因究明できる
- 他ツールではログを見るしかないことが多い
- リアルタイムでコマンド実行・検証が可能

**ローカルCLI**:
- Push前にローカル環境で設定ファイルのバリデーションやジョブ実行ができる
- 「お祈りPush」を避けられる
- 高速なフィードバックループ

**OIDC連携**:
- AWSのアクセスキーを直接持たせず、IAMロールで安全に通信する仕組みが標準的
- 一時的な認証トークンで最小権限の原則を実現

## 3. AWS連携のベストプラクティス

「S3からSQLを取得してテスト環境を作る」流れのベストプラクティスを整理します。

### 3.1 認証設定 (OIDC推奨)

**従来の方法 (非推奨)**:
- IAMユーザーのアクセスキーをCI環境変数に保存
- 長期的な認証情報の管理が必要
- 漏洩リスクが高い

**推奨: OIDC (OpenID Connect)**:
- IAMロールを使用
- 一時的なトークンでAWSへアクセス
- アクセスキーの管理が不要

### 3.2 データ取得・環境構築フロー

**ステップ1: 認証**
```yaml
# 例: CircleCIの場合
- aws-cli/setup:
    role_arn: "arn:aws:iam::123456789012:role/CircleCIRole"
```

**ステップ2: データ取得**
```bash
# S3からSQLファイルやフィクスチャデータを取得
aws s3 cp s3://my-bucket/test-data/schema.sql ./schema.sql
aws s3 cp s3://my-bucket/test-data/seed.sql ./seed.sql
```

**ステップ3: 環境構築**
```bash
# Dockerコンテナでデータベースを立ち上げ
docker run -d -p 5432:5432 postgres:16

# SQLを流し込み
psql -h localhost -U postgres -f schema.sql
psql -h localhost -U postgres -f seed.sql
```

### 3.3 データの準備・キャッシュ戦略

**CircleCIキャッシュ**:
- 重いライブラリや頻繁に使うデータはCI内にキャッシュ
- ビルド時間の短縮
- ネットワーク転送量の削減

**S3活用**:
- 長期保存が必要なログをS3に保存
- 巨大なテストデータセットはS3に保存し、必要な時だけ取得
- バージョン管理・ライフサイクル管理が可能

## 4. セルフホスト型ツールの選択肢

「クラウド代を浮かせたい」「社内環境に閉じたい」場合の推奨スペックと特徴です。

### 4.1 GitLab

**推奨スペック**:
- メモリ: 4GB以上必須
- CPU: 2コア以上
- ストレージ: 20GB以上

**特徴**:
- コード管理、CI/CD、セキュリティスキャンまで全部入り
- 高機能だが重い
- EC2のコストは高めになる

**適用シーン**:
- 中〜大規模チーム
- GitリポジトリとCI/CDを統合したい
- セキュリティスキャンやコンプライアンス機能が必要

### 4.2 Drone / Woodpecker

**推奨スペック**:
- メモリ: 512MB〜 (最小構成)
- CPU: 1コア (t3.microでも可)
- ストレージ: 10GB程度

**特徴**:
- 超軽量
- 全ステップがDockerコンテナ
- EC2無料枠（t3.micro等）で試すならこれが最適

**適用シーン**:
- 小規模チーム
- 低コスト運用
- Dockerの知識がそのまま活かせる

### 4.3 Jenkins

**推奨スペック**:
- メモリ: 2GB以上
- CPU: 2コア以上
- ストレージ: 可変（プラグイン次第）

**特徴**:
- 無限の拡張性
- プラグインエコシステムが豊富
- 独自の秘伝のタレを作れる

**課題**:
- 管理コスト（人件費）が最もかかる
- セキュリティアップデートの追従
- プラグイン依存による保守性の低下

## 5. 結論: どれから始めるべきか？

### 推奨パターン別

**パターン1: まずは「お祈りPush」を避けたい**
- **推奨**: CircleCI
- **理由**: 無料枠で試せる。CLIツールをインストールして、手元でvalidateする快適さを体験できる。
- **適用**: 個人プロジェクト、PoC、検証フェーズ

**パターン2: AWSとの親和性とコストを最優先したい**
- **推奨**: GitHub Actions
- **理由**: AWS公式のActionが多く、設定が楽。GitHub統合が自然。
- **適用**: GitHubを既に使っているチーム、AWS中心のインフラ

**パターン3: 自前サーバー（EC2）を安く使い倒したい**
- **推奨**: Woodpecker CI
- **理由**: 非常に軽量で、Dockerの知識がそのまま活かせる。低スペックEC2でも動作。
- **適用**: コスト最優先、社内環境に閉じたい、小規模チーム

### 本プロジェクトでの選定理由

**選定ツール**: Woodpecker CI

**理由**:
1. **低コスト**: t3.mediumで十分動作し、コストを抑えられる
2. **学習目的**: セルフホスト型CI/CDの構築・運用を学べる
3. **Docker知識の活用**: 全ステップがDockerコンテナで実行されるため、既存のDocker知識がそのまま使える
4. **AWS統合**: PostgreSQL（Aurora）との接続、API Gateway連携が容易
5. **シンプルさ**: YAMLベースの設定で、複雑な学習コストがかからない

**トレードオフの認識**:
- SSHデバッグ機能はない → ログベースのデバッグが必要
- ローカルCLIはない → 設定の検証はPush後に実施
- エンタープライズ機能は限定的 → 小規模検証には十分

## 6. 参考資料

- CircleCI公式ドキュメント: https://circleci.com/docs/
- GitHub Actions公式ドキュメント: https://docs.github.com/actions
- GitLab CI/CD公式ドキュメント: https://docs.gitlab.com/ee/ci/
- Jenkins公式サイト: https://www.jenkins.io/
- Woodpecker CI公式ドキュメント: https://woodpecker-ci.org/

## 7. 次のステップ候補

本プロジェクトでは既にWoodpecker CIで環境を構築済みですが、今後の展開として以下が考えられます：

1. **CircleCIでのOIDC設定**: IAMロールを使ったAWS連携の実装例
2. **GitHub Actionsへの移行**: マネージドサービスへの切り替え検討
3. **Lambda統合**: API Gateway MockからLambda統合への発展
4. **CI/CDパイプラインの拡張**: テストカバレッジ、静的解析、セキュリティスキャンの追加

---

**文書履歴**:
- 2025-12-27: 初版作成
