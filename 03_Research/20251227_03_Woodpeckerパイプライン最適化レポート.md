# Woodpeckerパイプライン最適化レポート

## 概要

本ドキュメントは、Woodpecker CIのパイプライン構成を最適化するための2つのアプローチを比較し、本プロジェクト（2601_venom）への適用を検討したレポートです。

**調査日**: 2025年12月27日

**調査目的**:
- 現在の単一ファイル構成から、より効率的な構成への移行を検討
- パイプラインの並列実行とファイル分割の利点・欠点を整理
- 本プロジェクトに最適な構成を推奨

**関連ドキュメント**:
- `03_Research/20251227_02_WoodpeckerとVenom技術調査.md` - Woodpecker CI技術詳細

## 1. 構成案の比較

現在の単一ファイルでの実行から、効率化・整理を行うための2つのアプローチを比較します。

### 比較表

| 項目 | A: `depends_on`による並列化 | B: `.woodpecker/`ディレクトリ構成 |
|------|---------------------------|--------------------------------|
| **構造** | 単一ファイル（`.woodpecker.yml`） | 複数ファイル（`.woodpecker/*.yml`） |
| **実行方式** | ステップ単位の並列実行 | パイプライン単位の完全独立実行 |
| **依存関係制御** | `depends_on`による明示的な制御 | ファイル名の接頭辞による順序制御（暗黙的） |
| **並列度** | 同一依存を持つステップが並列実行 | 全パイプラインが並列スケジュール可能 |
| **ファイル数** | 1つ | 複数（役割ごと） |
| **可読性** | すべての定義が1ファイルに集約 | 関心事の分離、役割ごとに明確 |
| **メンテナンス性** | ファイルが大きくなると低下 | ファイルが小さく、変更影響範囲が明確 |

### メリット・デメリット

#### A: `depends_on`による並列化

**メリット**:
- 依存関係が明確に記述される
- すべてのステップ定義が1ファイルで完結
- 記述がシンプル（追加の設定不要）
- パイプライン全体の流れが一目で把握できる

**デメリット**:
- ファイルサイズが大きくなる
- 関心事の分離が不十分
- Git差分が見づらくなる（すべての変更が同一ファイル）
- 複雑な依存関係になると管理が困難

**ユースケース**:
- DB起動を待ってから複数のAPIテストを走らせたい時
- 前処理→並列テスト→後処理の流れが明確な場合
- 小〜中規模のパイプライン（ステップ数10以下）

#### B: `.woodpecker/`ディレクトリ構成

**メリット**:
- 役割ごとにファイルを分離でき管理が楽
- 関心事の分離（DB初期化、テスト、デプロイ等）
- Git差分が明確（変更箇所のファイルのみ）
- パイプラインの追加・削除が容易
- 各ファイルが小さく、可読性が高い

**デメリット**:
- パイプライン間の依存関係が暗黙的
- 全体の流れを把握するには複数ファイルを確認する必要
- ファイル数が増える
- 接頭辞による順序制御が必要（`01-`, `02-`等）

**ユースケース**:
- 定期実行用とプッシュ用で処理を分けたい時
- 環境ごと（dev/staging/prod）にパイプラインを分けたい時
- 大規模パイプライン（ステップ数10以上）
- チーム開発で複数メンバーが同時編集する場合

## 2. サンプルA: `depends_on`を使った並列実行

単一のファイル内で、`setup-db`の完了を待ってから、複数のAPIテスト（ユーザー系、注文系など）を同時に開始する構成です。

### 実装例

```yaml
# .woodpecker.yml
pipeline:
  # ステップ1: データベースセットアップ（直列実行）
  setup-db:
    image: postgres:16
    environment:
      - PGPASSWORD=password123
    commands:
      - psql -h $DB_HOST -U postgres -d testdb -f src/sql/01_schema.sql
      - psql -h $DB_HOST -U postgres -d testdb -f src/sql/02_seed.sql

  # ステップ2: ユーザーAPIテスト（setup-db完了後に並列実行）
  test-user-api:
    image: ovhcom/venom:latest
    commands:
      - venom run src/tests/user_api_test.venom.yml --var "api_url=$API_URL"
    depends_on: [setup-db] # setup-dbが終わるまで待機

  # ステップ3: 注文APIテスト（setup-db完了後に並列実行）
  test-order-api:
    image: ovhcom/venom:latest
    commands:
      - venom run src/tests/order_api_test.venom.yml --var "api_url=$API_URL"
    depends_on: [setup-db] # test-user-apiと同時に開始される

  # ステップ4: 在庫APIテスト（setup-db完了後に並列実行）
  test-inventory-api:
    image: ovhcom/venom:latest
    commands:
      - venom run src/tests/inventory_api_test.venom.yml --var "api_url=$API_URL"
    depends_on: [setup-db]

  # ステップ5: レポート集計（全テスト完了後に実行）
  generate-report:
    image: alpine
    commands:
      - echo "All tests completed"
      - ls -la test-results/
    depends_on: [test-user-api, test-order-api, test-inventory-api]
```

### 実行フロー

```
setup-db
   |
   +----> test-user-api ----+
   |                        |
   +----> test-order-api ---+----> generate-report
   |                        |
   +----> test-inventory ---+
```

### 特徴

- **並列度**: 3つのテストステップが同時実行
- **実行時間**: DB初期化 + 最長テスト時間 + レポート生成
- **依存関係**: 明示的で理解しやすい
- **ファイル数**: 1つ（`.woodpecker.yml`のみ）

## 3. サンプルB: `.woodpecker/`による複数ファイル構成

リポジトリ直下にディレクトリを作成し、役割ごとにファイルを分割します。Woodpeckerはこれらを別々のジョブとして並列にスケジュールします。

### ディレクトリ構造

```
.
├── .woodpecker/
│   ├── 01-db-init.yml
│   ├── 02-api-test.yml
│   ├── 03-cleanup.yml
│   └── 04-deploy.yml (オプション)
├── src/
│   ├── sql/
│   ├── tests/
│   └── ...
└── README.md
```

### ファイル内容の例

#### 01-db-init.yml（DB初期化専用パイプライン）

```yaml
# .woodpecker/01-db-init.yml
kind: pipeline
name: db-initialization

steps:
  - name: wait-for-db
    image: alpine
    commands:
      - echo "Waiting for database to be ready..."
      - sleep 5

  - name: run-migrations
    image: postgres:16
    environment:
      - PGPASSWORD=password123
    commands:
      - psql -h $DB_HOST -U postgres -d testdb -f src/sql/01_schema.sql
      - psql -h $DB_HOST -U postgres -d testdb -f src/sql/02_seed.sql

  - name: verify-schema
    image: postgres:16
    environment:
      - PGPASSWORD=password123
    commands:
      - psql -h $DB_HOST -U postgres -d testdb -c "\\dt"
      - psql -h $DB_HOST -U postgres -d testdb -c "SELECT COUNT(*) FROM users;"

when:
  event: [push, pull_request, manual]
```

#### 02-api-test.yml（API統合テスト専用パイプライン）

```yaml
# .woodpecker/02-api-test.yml
kind: pipeline
name: api-integration-tests

steps:
  - name: run-venom-tests
    image: ovhcom/venom:latest
    commands:
      - venom run src/tests/*.venom.yml --var "api_url=$API_URL" --var "db_url=$DB_URL" --format=xml --output-dir=test-results

  - name: upload-results
    image: plugins/s3
    settings:
      bucket: test-results
      source: test-results/**/*.xml
      target: /venom-reports/${CI_COMMIT_SHA}/
    when:
      status: [success, failure]

when:
  event: [push, pull_request]
```

#### 03-cleanup.yml（クリーンアップ専用パイプライン）

```yaml
# .woodpecker/03-cleanup.yml
kind: pipeline
name: cleanup

steps:
  - name: truncate-tables
    image: postgres:16
    environment:
      - PGPASSWORD=password123
    commands:
      - psql -h $DB_HOST -U postgres -d testdb -c "TRUNCATE TABLE users CASCADE;"

  - name: remove-temp-files
    image: alpine
    commands:
      - rm -rf /tmp/test-data/*

when:
  event: [manual] # 手動実行のみ
```

### 実行フロー

```
# Pushイベント時の並列実行
01-db-init (パイプライン1)
   |
   v
02-api-test (パイプライン2) ← 独立して並列実行可能

# 手動実行時のみ
03-cleanup (パイプライン3)
```

### 特徴

- **並列度**: パイプライン単位で完全独立（Woodpeckerが自動スケジューリング）
- **実行時間**: 各パイプラインが独立して実行（並列化による高速化）
- **依存関係**: ファイル名の接頭辞（`01-`, `02-`）で暗黙的な順序
- **ファイル数**: 役割ごとに複数（3-5ファイル程度）

## 4. 本プロジェクトへの適用検討

### 4.1 現在の構成

**ファイル**: `.woodpecker.yml`（単一ファイル）

**ステップ構成**:
```yaml
pipeline:
  setup-db:     # DB初期化
  test:         # Venomテスト実行
```

**特徴**:
- シンプルで理解しやすい
- ステップ数が少ない（2ステップ）
- 直列実行のみ

### 4.2 適用パターン別評価

#### パターン1: 現状維持（変更なし）

**推奨度**: ★★★★☆

**理由**:
- ステップ数が少なく、現状で十分シンプル
- 並列化による効果が限定的（DB初期化後にテスト1つのみ）
- 保守性が高い

**適用判断**: 現状のままで問題なし

#### パターン2: `depends_on`による並列化

**推奨度**: ★★★☆☆

**理由**:
- Venomテストを複数に分割した場合に有効
- 例: `user_api_test.venom.yml`、`order_api_test.venom.yml`に分割
- DB初期化後に並列実行可能

**適用条件**:
- Venomテストファイルを役割別に分割する場合
- テスト実行時間が長くなった場合（並列化で高速化）

**実装例**:
```yaml
pipeline:
  setup-db:
    # 現在と同じ

  test-db-integration:
    image: ovhcom/venom:latest
    commands:
      - venom run src/tests/db_test.venom.yml
    depends_on: [setup-db]

  test-api-integration:
    image: ovhcom/venom:latest
    commands:
      - venom run src/tests/api_test.venom.yml
    depends_on: [setup-db]
```

#### パターン3: `.woodpecker/`ディレクトリ構成

**推奨度**: ★★☆☆☆

**理由**:
- 現状のステップ数では過剰な分割
- ファイル数が増えることによる複雑化
- 小規模プロジェクトには不向き

**適用条件**:
- 将来的にパイプラインが大幅に増える場合
- 環境別（dev/staging/prod）のパイプラインが必要な場合
- 定期実行バッチ等の追加が予定されている場合

**将来の拡張例**:
```
.woodpecker/
├── 01-db-init.yml      # DB初期化
├── 02-integration.yml  # 統合テスト
├── 03-security.yml     # セキュリティスキャン
├── 04-deploy-dev.yml   # Dev環境デプロイ
└── 05-deploy-prod.yml  # Prod環境デプロイ
```

## 5. 推奨構成と移行計画

### 5.1 短期推奨（現在のフェーズ）

**推奨構成**: 現状維持（単一ファイル、直列実行）

**理由**:
- ステップ数が少なく（2ステップ）、最適化の必要性が低い
- 学習・検証フェーズとして、シンプルな構成を維持する方が適切
- パイプライン実行時間が短い（数分以内）

**実施事項**:
- なし（現状のままでOK）

### 5.2 中期推奨（テスト拡張時）

**推奨構成**: `depends_on`による並列化

**条件**:
- Venomテストが3つ以上に分割された場合
- パイプライン実行時間が5分以上になった場合

**実施事項**:
1. Venomテストファイルを役割別に分割
   ```
   src/tests/
   ├── db_integration_test.venom.yml
   ├── api_mock_test.venom.yml
   └── e2e_test.venom.yml
   ```

2. `.woodpecker.yml`に並列実行を追加
   ```yaml
   pipeline:
     setup-db:
       # 既存

     test-db:
       depends_on: [setup-db]
       # DB統合テスト

     test-api:
       depends_on: [setup-db]
       # API Mockテスト

     test-e2e:
       depends_on: [test-db, test-api]
       # E2Eテスト
   ```

### 5.3 長期推奨（本番運用時）

**推奨構成**: `.woodpecker/`ディレクトリ構成

**条件**:
- パイプラインが5つ以上に増えた場合
- 環境別デプロイが必要になった場合
- 定期実行ジョブが追加された場合

**実施事項**:
1. `.woodpecker/`ディレクトリ作成
2. 役割ごとにファイル分割
3. Git履歴の整理（リファクタリングコミット）

## 6. ベストプラクティス

### 6.1 `depends_on`使用時の注意点

**明示的な依存関係**:
```yaml
# Good: 依存関係が明確
test-api:
  depends_on: [setup-db]

# Bad: 依存関係が暗黙的（実行順序に依存）
test-api:
  # depends_onなし → setup-dbと並列実行される可能性
```

**循環依存の回避**:
```yaml
# Bad: 循環依存（エラー）
step-a:
  depends_on: [step-b]
step-b:
  depends_on: [step-a]
```

**複数依存の記述**:
```yaml
# Good: すべての依存を明示
final-step:
  depends_on: [test-a, test-b, test-c]
```

### 6.2 `.woodpecker/`使用時の注意点

**命名規則の統一**:
```
# Good: 接頭辞で順序を明示
01-init.yml
02-test.yml
03-deploy.yml

# Bad: 順序が不明確
init.yml
test.yml
deploy.yml
```

**when条件の活用**:
```yaml
when:
  event: [push]           # Pushイベントのみ
  branch: [main, develop] # 特定ブランチのみ
```

**パイプライン名の明確化**:
```yaml
# Good: パイプライン名が役割を示す
kind: pipeline
name: security-scan

# Bad: 名前が汎用的
kind: pipeline
name: pipeline-2
```

## 7. まとめ

### 選択基準

| プロジェクト規模 | ステップ数 | 推奨構成 |
|---------------|-----------|---------|
| 小規模（学習・検証） | 2-5 | 単一ファイル |
| 中規模（開発） | 5-10 | `depends_on`並列化 |
| 大規模（本番運用） | 10+ | `.woodpecker/`分割 |

### 本プロジェクトの推奨

**現在**: 単一ファイル（現状維持）
**次のステップ**: Venomテスト分割時に`depends_on`導入を検討
**将来**: 環境別デプロイ追加時に`.woodpecker/`への移行を検討

### 参考資料

- Woodpecker CI - Workflow Syntax: https://woodpecker-ci.org/docs/usage/workflow-syntax
- Woodpecker CI - Pipeline Syntax (depends_on): https://woodpecker-ci.org/docs/usage/workflows
- Woodpecker CI - Multi-Pipeline: https://woodpecker-ci.org/docs/usage/multi-pipeline

---

**文書履歴**:
- 2025-12-27: 初版作成
