# AWS環境再構築 - 2026/01/14

## 実施日時
2026年1月14日

## 実施内容
10_再構築手順.mdに基づいて、AWS環境をTerraformで再構築しました。

## 実施手順

### 1. Terraform初期化
```bash
cd /home/naka/claude_code/2601_venom/src/terraform
terraform init
```

**結果**: 成功
- AWS Provider v6.27.0を使用
- 既存の依存関係を再利用

### 2. Terraform Plan実行
```bash
terraform plan
```

**結果**: 24個のリソースが作成予定
- VPC、Subnet、IGW、Route Table
- Security Groups (EC2用、DB用)
- Aurora Serverless v2 Cluster (PostgreSQL 16.10)
- EC2 Instance (t3.medium, Amazon Linux 2023)
- Elastic IP
- API Gateway (Mock API)

### 3. Terraform Apply実行
```bash
terraform apply -auto-approve
```

**結果**: 成功
- 全24リソースが正常に作成されました
- 所要時間: 約3-4分

### 4. 出力値の確認
```bash
terraform output
```

**取得した出力値**:
```
ami_id              = "ami-0187818ae1557b139"
api_gateway_url     = "https://8fb47xdz6i.execute-api.ap-northeast-1.amazonaws.com/dev/users"
db_endpoint         = "woodpecker-db-cluster.cluster-cbuqsk2gi5o4.ap-northeast-1.rds.amazonaws.com"
woodpecker_public_ip = "13.158.95.95"
```

## 構築されたリソース

### ネットワーク
- **VPC**: woodpecker-test-vpc (10.0.0.0/16)
- **Public Subnet**: 10.0.1.0/24 (ap-northeast-1a)
- **Private Subnet A**: 10.0.2.0/24 (ap-northeast-1a)
- **Private Subnet C**: 10.0.3.0/24 (ap-northeast-1c)
- **Internet Gateway**: VPCに接続済み

### セキュリティグループ
- **EC2 Security Group**: SSH(22)、Woodpecker UI(8000)を許可
- **DB Security Group**: EC2からのPostgreSQL(5432)接続を許可

### コンピュート
- **EC2 Instance**: woodpecker-server
  - Instance Type: t3.medium
  - AMI: Amazon Linux 2023 (ami-0187818ae1557b139)
  - Public IP: 13.158.95.95 (Elastic IP)
  - User Data: Docker、Git、Docker Compose自動インストール

### データベース
- **Aurora Serverless v2 Cluster**: woodpecker-db-cluster
  - Engine: aurora-postgresql 16.10
  - Min Capacity: 0.0 ACU (自動停止機能あり)
  - Max Capacity: 1.0 ACU
  - Database Name: testdb
  - Master User: postgres
  - Endpoint: woodpecker-db-cluster.cluster-cbuqsk2gi5o4.ap-northeast-1.rds.amazonaws.com

### API Gateway
- **Mock API**: woodpecker-mock-api
  - Endpoint: https://8fb47xdz6i.execute-api.ap-northeast-1.amazonaws.com/dev/users
  - リソース: GET /users/{id}
  - Stage: dev

## 次のステップ

以下の手順を実施する必要があります:

### ステップ2: GitHub OAuth設定 (未実施)
- GitHub OAuth Applicationの作成または更新
- Callback URL: `http://13.158.95.95:8000/authorize`
- Client IDとClient Secretの取得

### ステップ3: EC2セットアップ (未実施)
- EC2にEC2 Instance Connectで接続
- リポジトリのクローン
- GitHub Personal Access Tokenの設定

### ステップ4: Woodpecker構築 (未実施)
- setup.shの実行
- Docker Composeでのコンテナ起動
- Woodpecker UI確認 (`http://13.158.95.95:8000`)

### ステップ5: 動作確認 (未実施)
- リポジトリの有効化
- パイプラインの手動実行
- DB接続確認

## 注意事項

### Aurora起動時間
- Aurora Serverless v2は初回アクセス時に0.0 ACUから起動します
- 起動には15-30秒程度かかる場合があります
- パイプライン実行時に接続エラーが出る場合は少し待ってから再実行してください

### セキュリティ
- 検証環境のため、Security Groupは0.0.0.0/0からのアクセスを許可しています
- DBパスワードは簡易設定(password123)です
- 本番環境では適切なセキュリティ設定を行ってください

### コスト
- EC2 t3.medium: 停止しない限り継続課金
- Aurora Serverless v2: 0.0 ACUで自動停止、使用時のみ課金
- Elastic IP: EC2に関連付けられているため無料
- 使用しない場合は`terraform destroy`でリソースを削除してください

## トラブルシューティング

### Terraform実行時のエラー
- `terraform init`を再実行してください
- AWSクレデンシャルが正しく設定されているか確認してください

### リソース作成失敗
- AWS Consoleでリソースの状態を確認してください
- エラーメッセージを確認し、該当リソースを手動削除後に再実行してください

## 参考ドキュメント
- 01_Document/10_再構築手順.md: 詳細な再構築手順
- 01_Document/02_AWS環境設計.md: インフラ設計詳細
- src/terraform/main.tf: Terraformコード

## ステータス
- [x] ステップ1: AWS環境構築 (完了)
- [ ] ステップ2: GitHub OAuth設定
- [ ] ステップ3: EC2セットアップ
- [ ] ステップ4: Woodpecker構築
- [ ] ステップ5: 動作確認
