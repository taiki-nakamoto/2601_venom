# 次回作業予定

作成日: 2025-12-26

## 本日までの完了項目

### ドキュメント作成
- ✅ 01_Woodpecker検証プラン.md - プロジェクト概要と検証フェーズ
- ✅ 02_AWS環境設計.md - インフラ構成図とリソース設計、Terraform実行手順
- ✅ 03_EC2接続手順.md - EC2 Instance Connectを使った接続方法
- ✅ 04_venom構築.md - Venom構築手順とパイプライン設定
- ✅ 05_DBサンプル.md - usersテーブル設計とER図、テストシナリオ

### ソースコード作成
- ✅ src/terraform/main.tf - AWS環境構築用Terraformスクリプト
- ✅ src/setup.sh - 自動セットアップスクリプト
- ✅ src/docker-compose.yml - Woodpeckerサーバー/エージェント設定
- ✅ src/.woodpecker.yml - CI/CDパイプライン定義（setup-db + test）
- ✅ src/sql/01_schema.sql - usersテーブルDDL
- ✅ src/sql/02_seed.sql - 初期データ投入DML
- ✅ src/tests/api_db_test.venom.yml - Venomテスト定義
- ✅ src/README.md - 使い方ガイドとトラブルシューティング

## 次回の作業予定

### 1. AWS環境の構築（所要時間: 約15-20分）

#### 1.1 Terraform実行
```bash
cd /home/naka/claude_code/2601_venom/src/terraform
terraform init
terraform apply
```

**確認事項:**
- VPCとサブネットが正しく作成されたか
- EC2インスタンスが起動しているか
- Aurora Serverless v2が作成されたか（約10-15分かかる）
- 出力値（woodpecker_public_ip, db_endpoint）を記録

**想定される課題:**
- Aurora作成の待ち時間
- Security Groupの設定確認

#### 1.2 EC2への接続確認
- AWS ConsoleからEC2 Instance Connectで接続
- Dockerとdocker-composeがインストールされているか確認
  ```bash
  docker --version
  docker-compose --version
  ```

### 2. GitHub OAuth設定（所要時間: 約5分）

**手順:**
1. GitHubで新しいOAuthアプリケーションを作成
   - Settings → Developer settings → OAuth Apps → New OAuth App
2. 必要な情報を設定:
   - Application name: `Woodpecker Test`
   - Homepage URL: `http://<woodpecker_public_ip>:8000`
   - Authorization callback URL: `http://<woodpecker_public_ip>:8000/authorize`
3. Client IDとClient Secretを記録

### 3. Woodpecker環境のセットアップ（所要時間: 約10分）

#### 3.1 setup.shの実行
```bash
cd ~
# srcディレクトリの内容をEC2にコピー（scp, git clone等）
chmod +x setup.sh
./setup.sh
```

**入力が必要な情報:**
- EC2 Public IP: `<terraform outputから>`
- GitHub Client ID: `<GitHubから取得>`
- GitHub Client Secret: `<GitHubから取得>`
- Aurora Endpoint: `<terraform outputから>`
- API Gateway URL: `<後で設定するため仮でOK>`

#### 3.2 Woodpecker UI確認
- ブラウザで `http://<EC2 Public IP>:8000` にアクセス
- GitHubでログイン
- リポジトリを有効化

### 4. Venomテストの検証（所要時間: 約30-60分）

#### 4.1 DB接続テスト
**目的:** EC2からAuroraへの接続確認

```bash
# PostgreSQLクライアントをインストール
sudo dnf install -y postgresql16

# 接続テスト
psql -h <aurora-endpoint> -U postgres -d testdb
# パスワード: password123

# 接続後、テーブルを確認
\dt
```

**確認事項:**
- Security Groupが正しく設定されているか
- Auroraが起動しているか（0.0 ACUからの起動に15-30秒）

#### 4.2 SQLファイルの手動実行テスト
```bash
export PGPASSWORD=password123
psql -h <aurora-endpoint> -U postgres -d testdb -f sql/01_schema.sql
psql -h <aurora-endpoint> -U postgres -d testdb -f sql/02_seed.sql

# データ確認
psql -h <aurora-endpoint> -U postgres -d testdb -c "SELECT * FROM users;"
```

#### 4.3 API Gateway Mockの作成（オプション）
**注:** 時間がない場合は後回しでもOK

- AWS ConsoleでAPI Gateway Mockを作成
- `/users/{id}` エンドポイントを作成
- Mockレスポンスを設定

#### 4.4 .woodpecker.ymlのテスト
**GitHubリポジトリの準備:**
```bash
# 新しいGitHubリポジトリを作成
# src/配下のファイルをコミット
git init
git add .woodpecker.yml sql/ tests/
git commit -m "Add Woodpecker CI configuration"
git remote add origin <your-repo-url>
git push -u origin main
```

**Woodpecker UIでの確認:**
1. リポジトリを有効化
2. 手動でビルドをトリガー
3. ログを確認:
   - setup-dbステップが成功しているか
   - testステップが実行されているか

### 5. トラブルシューティングと調整（所要時間: 予備時間）

**想定される問題:**
- DB接続エラー → Security Group確認
- Venomテスト失敗 → API Gateway Mockの設定確認
- Woodpeckerが起動しない → docker-composeログ確認

## 検証のゴール

1. ✅ **インフラ構築**: Terraform でVPC、EC2、Auroraが正しく作成される
2. ✅ **CI基盤**: Woodpeckerが起動し、GitHubと連携できる
3. ✅ **DB連携**: Woodpeckerから`setup-db`ステップでAuroraにSQLを実行できる
4. ✅ **Venomテスト**: `test`ステップでVenomがDBを更新し、API（Mock）を呼び出せる

## 成果物（次回作業後）

- [ ] Terraformで構築されたAWS環境のスクリーンショット
- [ ] Woodpecker UIでのビルド成功ログ
- [ ] Venomテスト実行結果
- [ ] 03_Research配下に検証レポートを作成

## 参考資料

- `01_Document/01_Woodpecker検証プラン.md` - 検証の全体像
- `01_Document/02_AWS環境設計.md` - インフラ設計と実行手順
- `01_Document/04_venom構築.md` - Venom構築手順
- `src/README.md` - 詳細な使い方とトラブルシューティング

## メモ

- Auroraは0.0 ACUのため、非アクティブ時は自動停止
- 検証終了後は `terraform destroy` でリソースを削除してコスト削減
- 数時間のテスト想定のため、セキュリティ設定は最小限
