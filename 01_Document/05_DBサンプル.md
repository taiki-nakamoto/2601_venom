# DBサンプル

## 1. ER図

```mermaid
erDiagram
    users {
        integer id PK "SERIAL / Primary Key"
        varchar username "NOT NULL (50)"
        varchar email UK "UNIQUE / NOT NULL (255)"
        text address "Optional"
        varchar status "DEFAULT 'active' (20)"
        varchar created_by "Audit: Created User"
        timestamp created_at "DEFAULT now()"
        varchar updated_by "Audit: Updated User"
        timestamp updated_at "DEFAULT now()"
    }
```

## 2. ユーザーテーブル詳細設計 (users)

テストのしやすさを考慮し、ステータス（有効/無効）やメタデータを含めています。

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | INTEGER | PRIMARY KEY | ユーザーID（検証時に指定しやすいよう連番想定） |
| username | VARCHAR(50) | NOT NULL | ログインIDや表示名 |
| email | VARCHAR(255) | UNIQUE | メールアドレス（一意性テストに利用） |
| address | TEXT | - | 住所情報 |
| status | VARCHAR(20) | DEFAULT 'active' | 更新テスト用（'active', 'inactive', 'deleted'など） |
| created_by | VARCHAR(50) | - | 作成者（'system', 'admin'など） |
| created_at | TIMESTAMP | DEFAULT now() | レコード作成日時 |
| updated_by | VARCHAR(50) | - | 更新確認用（'ci-bot' などに書き換えて検証） |
| updated_at | TIMESTAMP | DEFAULT now() | 更新確認用（更新時に時間が変わるかチェック） |

## 3. テーブル作成・初期データ投入SQL

これを `setup.sh` 内の Venom 定義、あるいは直接 DB で実行することで検証環境が整います。

```sql
-- テーブル作成
CREATE TABLE IF NOT EXISTS users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    address TEXT,
    status VARCHAR(20) DEFAULT 'active',
    created_by VARCHAR(50),
    created_at TIMESTAMP DEFAULT now(),
    updated_by VARCHAR(50),
    updated_at TIMESTAMP DEFAULT now()
);

-- テスト用初期データの投入
-- ON CONFLICT を入れることで、何度実行してもエラーにならないようにします
INSERT INTO users (id, username, email, address, status, created_by, updated_by)
VALUES (100, 'test_user_01', 'test@example.com', 'Tokyo, Japan', 'inactive', 'setup_script', 'setup_script')
ON CONFLICT (id) DO NOTHING;
```

## 4. テストシナリオ例

このテーブル設計を使用した検証シナリオの例：

### シナリオ1: ステータス更新テスト
```sql
-- ステータスをinactiveからactiveに変更
UPDATE users SET status = 'active', updated_by = 'venom_test' WHERE id = 100;

-- API Gatewayを叩いてステータスがactiveになっていることを確認
-- (Venomのhttpステップで検証)
```

### シナリオ2: 複数ユーザーの一括処理テスト
```sql
-- 複数のテストユーザーを追加
INSERT INTO users (id, username, email, address, status, created_by, updated_by)
VALUES
  (101, 'test_user_02', 'test2@example.com', 'Osaka, Japan', 'active', 'setup_script', 'setup_script'),
  (102, 'test_user_03', 'test3@example.com', 'Kyoto, Japan', 'deleted', 'setup_script', 'setup_script')
ON CONFLICT (id) DO NOTHING;

-- APIで一覧取得し、ステータスでフィルタリングされることを確認
```

### シナリオ3: 異常系テスト
```sql
-- 存在しないユーザーIDを指定した場合のAPI応答確認
-- (Venomのhttpステップで404を期待)
```

## 5. Venomテストでの利用例

このテーブルを使った `api_db_test.venom.yml` の拡張例：

```yaml
name: User Status Update Test
vars:
  api_url: "https://example.com/api"
  db_url: "postgres://postgres:password123@db-endpoint:5432/testdb"

testcases:
  - name: Setup and test user status change
    steps:
      # ステップ1: テーブルとデータの準備
      - type: dbfixtures
        database: postgres
        dsn: "{{.db_url}}"
        commands:
          - "CREATE TABLE IF NOT EXISTS users (id SERIAL PRIMARY KEY, username VARCHAR(50) NOT NULL, email VARCHAR(255) UNIQUE NOT NULL, address TEXT, status VARCHAR(20) DEFAULT 'active', created_by VARCHAR(50), created_at TIMESTAMP DEFAULT now(), updated_by VARCHAR(50), updated_at TIMESTAMP DEFAULT now());"
          - "INSERT INTO users (id, username, email, address, status, created_by, updated_by) VALUES (100, 'test_user_01', 'test@example.com', 'Tokyo, Japan', 'inactive', 'setup_script', 'setup_script') ON CONFLICT (id) DO NOTHING;"

      # ステップ2: ステータスをactiveに更新
      - type: dbfixtures
        database: postgres
        dsn: "{{.db_url}}"
        commands:
          - "UPDATE users SET status = 'active', updated_by = 'venom_test' WHERE id = 100;"

      # ステップ3: APIでステータスを確認
      - type: http
        method: GET
        url: "{{.api_url}}/users/100"
        assertions:
          - result.statuscode ShouldEqual 200
          - result.bodyjson.id ShouldEqual 100
          - result.bodyjson.status ShouldEqual "active"
          - result.bodyjson.updated_by ShouldEqual "venom_test"
```

## 6. 注意事項

- **id列はSERIAL型**を使用していますが、テストデータでは明示的にIDを指定しています
- `ON CONFLICT (id) DO NOTHING` により、同じスクリプトを複数回実行してもエラーになりません
- `created_at` と `updated_at` は自動的に現在時刻が設定されます
- テスト後のクリーンアップが必要な場合は、以下のコマンドでデータを削除できます：
  ```sql
  DELETE FROM users WHERE id >= 100 AND id < 200;
  ```
