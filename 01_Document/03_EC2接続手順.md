# EC2接続手順

EC2構築後の初期ログインには、**「EC2 Instance Connect」** を利用するのが最も簡単でスピーディです。

従来のSSHクライアント（Tera Term等）の設定や秘密鍵（.pem）の管理が不要で、AWSコンソール（ブラウザ）からボタン一つでログインできます。

## 1. ログイン手順（最速の方法）

1. AWSコンソールで「EC2」サービスを開きます

2. 左メニューの「インスタンス」を選択し、作成した `woodpecker-server` をチェックします

3. 画面右上の **「接続」** ボタンをクリックします

4. **「EC2 Instance Connect」** タブが選択されていることを確認します
   - ユーザー名： `ec2-user` （デフォルトのまま）

5. 右下の **「接続」** をクリックすると、ブラウザ上で新しいタブが開き、ターミナル画面が表示されます

## 2. ログイン後に最初に行う作業

ログインしたら、WoodpeckerやVenomを動かすために以下の準備を順に進めます。

### ① インストールの確認

Terraformの `user_data` でDockerをインストールする設定にしていますが、完了まで数分かかる場合があります。以下のコマンドで確認してください。

```bash
docker --version
docker-compose --version
```

もしコマンドが見つからない場合は、インストールが完了していない可能性があります。数分待ってから再度実行してください。

### ② 作業用ディレクトリの作成

```bash
mkdir ~/woodpecker-test && cd ~/woodpecker-test
```

### ③ 設定ファイルの作成

ここで `vi` などのエディタを使い、以前お伝えした `docker-compose.yml` や Venom の `*.venom.yml` を作成します。

```bash
# 例: docker-compose.yml の作成
vi docker-compose.yml
```

## 3. ファイル作成に便利なTips

ブラウザのターミナル（EC2 Instance Connect）では、**「コピー＆ペースト」** が可能です。

### ペースト方法

- `Ctrl + V`（または右クリック > 貼り付け）で、手元のPCで作成したYAMLの内容をそのまま流し込めます

### ファイルの流し込み

もし手元にファイルがある場合は、以下のコマンドで直接流し込むことも可能です。

```bash
cat << 'EOF' > test.venom.yml
[ここにYAMLの内容を貼り付け]
EOF
```

**使用例:**

```bash
cat << 'EOF' > docker-compose.yml
services:
  woodpecker-server:
    image: woodpeckerci/woodpecker-server:latest
    ports:
      - "8000:8000"
    # ... 以下続く
EOF
```

## 4. セキュリティに関する補足

今回のTerraform構成では、SSM（セッションマネージャー）用のIAMロールも付与しています。

もしネットワーク制限等で **EC2 Instance Connect** が使えない場合は、接続画面で **「セッションマネージャー」** タブを選んで接続を試みてください。こちらもブラウザ完結でログイン可能です。

### セッションマネージャーでの接続手順

1. EC2の「接続」ボタンをクリック
2. **「セッションマネージャー」** タブを選択
3. **「接続」** をクリック

この方法も秘密鍵不要で、AWS Systems Managerを経由した安全な接続が可能です。
