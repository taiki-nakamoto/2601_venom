# 再構築手順

## 概要

このドキュメントでは、クリーンアップ後に環境を再構築する手順を説明します。

**前提条件**:
- GitHubリポジトリ（`https://github.com/taiki-nakamoto/2601_venom`）が作成済み
- ローカルPCにリポジトリがクローン済み
- 必要な認証情報（GitHub OAuth、Personal Access Token）を準備済み

**所要時間**: 約30-45分（Auroraの起動待ち時間を含む）

## 準備

### 必要な情報

以下の情報を事前に準備してください：

- [ ] GitHubアカウント（taiki-nakamoto）
- [ ] GitHub Personal Access Token（`repo` スコープ）
- [ ] GitHub OAuth Application（新規作成または既存のものを使用）
  - Client ID
  - Client Secret

## ステップ1: AWS環境の構築（15-20分）

### 1.1 Terraformの初期化と実行

```bash
# リポジトリのterraformディレクトリに移動
cd /home/naka/claude_code/2601_venom/src/terraform

# Terraform初期化
terraform init

# 実行計画の確認
terraform plan

# 環境構築の実行
terraform apply
```

**確認プロンプト**:
```
Do you want to perform these actions?
  Enter a value: yes
```

`yes` と入力してEnterを押します。

**チェック項目**:
- [ ] エラーなく完了した
- [ ] "Apply complete!" が表示された

### 1.2 出力値の記録

```bash
# 出力値を表示
terraform output
```

以下の値をメモまたはコピーしてください：

```
woodpecker_public_ip = "54.xxx.xxx.xxx"
db_endpoint = "woodpecker-db-cluster.cluster-xxx.ap-northeast-1.rds.amazonaws.com"
api_gateway_url = "https://xxxxxx.execute-api.ap-northeast-1.amazonaws.com/dev/users"
ami_id = "ami-xxxxxxxxx"
```

**チェック項目**:
- [ ] `woodpecker_public_ip` を記録した
- [ ] `db_endpoint` を記録した
- [ ] `api_gateway_url` を記録した

### 1.3 AWS Consoleでの確認

AWS Console（ap-northeast-1リージョン）で以下を確認：

**チェック項目**:
- [ ] EC2: `woodpecker-server` が **running** 状態
- [ ] RDS: `woodpecker-db-cluster` が **available** 状態
- [ ] API Gateway: `woodpecker-mock-api` が作成されている

**注意**: Auroraが **creating** 状態の場合、10-15分待つ必要があります。

## ステップ2: GitHub OAuth Applicationの設定（5分）

### 2.1 新規作成の場合

GitHub OAuth Applicationをまだ作成していない場合：

1. GitHub → Settings → Developer settings → OAuth Apps
2. 「New OAuth App」をクリック
3. 以下を入力：
   - **Application name**: `Woodpecker CI Test`
   - **Homepage URL**: `http://<woodpecker_public_ip>:8000`
   - **Authorization callback URL**: `http://<woodpecker_public_ip>:8000/authorize`
4. 「Register application」をクリック
5. Client IDとClient Secretを記録

### 2.2 既存のものを更新する場合

1. GitHub → Settings → Developer settings → OAuth Apps → 既存のアプリを選択
2. 以下を更新：
   - **Homepage URL**: `http://<新しいwoodpecker_public_ip>:8000`
   - **Authorization callback URL**: `http://<新しいwoodpecker_public_ip>:8000/authorize`
3. 「Update application」をクリック

**チェック項目**:
- [ ] Client IDを記録した
- [ ] Client Secretを記録した
- [ ] Callback URLが正しいIPアドレスになっている

## ステップ3: EC2への接続とセットアップ（10分）

### 3.1 EC2 Instance Connectで接続

1. AWS Console → EC2 → インスタンス
2. `woodpecker-server` を選択
3. 「接続」→「EC2 Instance Connect」
4. ユーザー名: `ec2-user`
5. 「接続」をクリック

**チェック項目**:
- [ ] EC2にログインできた
- [ ] プロンプト `[ec2-user@ip-xxx ~]$` が表示されている

### 3.2 Docker/Gitの確認

```bash
# Dockerの確認
docker --version

# Gitの確認
git --version

# Gitがインストールされていない場合
sudo dnf install -y git
```

**チェック項目**:
- [ ] Dockerがインストールされている
- [ ] Gitがインストールされている

### 3.3 リポジトリのクローン

```bash
# ホームディレクトリに移動
cd ~

# リポジトリをクローン
git clone https://github.com/taiki-nakamoto/2601_venom.git

# 認証情報を入力
# Username: taiki-nakamoto
# Password: <Personal Access Token>

# ディレクトリに移動
cd 2601_venom
ls -la
```

**チェック項目**:
- [ ] クローンが成功した
- [ ] `src/`, `01_Document/` 等が確認できる

### 3.4 Gitユーザー設定

```bash
# Gitユーザー設定（push時に必要）
git config --global user.email "you@example.com"
git config --global user.name "Your Name"
```

### 3.5 Personal Access Tokenの保存

```bash
# secrets.txtに保存
cd ~/2601_venom/src
echo "GITHUB_TOKEN=ghp_xxxxxxxxxxxxxxxxxxxx" > secrets.txt
chmod 600 secrets.txt
```

**チェック項目**:
- [ ] Personal Access Tokenを保存した

## ステップ4: Woodpeckerの構築（5分）

### 4.1 setup.shの実行

```bash
cd ~/2601_venom/src
chmod +x setup.sh
./setup.sh
```

**入力が必要な情報**:
- EC2 Public IP: `<Terraform出力から>`
- GitHub Client ID: `<GitHub OAuth Appから>`
- GitHub Client Secret: `<GitHub OAuth Appから>`
- Aurora Endpoint: `<Terraform出力から>`
- API Gateway URL: `<Terraform出力から>`

**チェック項目**:
- [ ] すべての情報を正しく入力した
- [ ] `Starting Woodpecker...` が表示された
- [ ] エラーが表示されていない

### 4.2 Woodpecker UIの確認

ブラウザで以下にアクセス：

```
http://<woodpecker_public_ip>:8000
```

**チェック項目**:
- [ ] Woodpecker UIが表示される
- [ ] 「Login with GitHub」ボタンがある
- [ ] GitHubでログインできる

### 4.3 リポジトリの有効化

1. Woodpecker UI → Repositories
2. `2601_venom` リポジトリを探す
3. 「Enable」をクリック

**チェック項目**:
- [ ] リポジトリが有効化された

## ステップ5: 動作確認（5-10分）

### 5.1 手動パイプラインの実行

1. Woodpecker UI → リポジトリ → Pipelines
2. 「Trigger pipeline」をクリック
3. ブランチ: `main` を選択
4. 「Start pipeline」をクリック

**チェック項目**:
- [ ] パイプラインが開始された
- [ ] `setup-db` ステップが成功した
- [ ] `test` ステップが成功した

### 5.2 ログの確認

**setup-db ステップ**:
```
CREATE TABLE
INSERT 0 1
```

**test ステップ**:
```
• API Integration Test with Aurora (api_db_test.venom.yml)
  • Check API response after DB update SUCCESS
```

**チェック項目**:
- [ ] `CREATE TABLE` が表示されている
- [ ] `INSERT 0 1` が表示されている
- [ ] `SUCCESS` が表示されている

### 5.3 DB接続確認（オプション）

```bash
# PostgreSQLクライアントのインストール
sudo dnf install -y postgresql16

# 環境変数設定
export PGPASSWORD=password123
export DB_ENDPOINT=<Terraform出力のdb_endpoint>

# データ確認
psql -h $DB_ENDPOINT -U postgres -d testdb -c "SELECT * FROM users;"
```

**期待される出力**:
```
 id  |   username   |      email       |   address    | status   | ...
-----+--------------+------------------+--------------+----------+-----
 100 | test_user_01 | test@example.com | Tokyo, Japan | inactive | ...
```

**チェック項目**:
- [ ] DBに接続できた
- [ ] usersテーブルにデータが存在する

## 再構築完了チェックリスト

### 必須項目
- [ ] Terraform applyが成功した
- [ ] EC2にログインできた
- [ ] リポジトリをクローンした
- [ ] Woodpecker UIが表示された
- [ ] パイプラインが成功した

### 確認項目
- [ ] すべての出力値を記録した
- [ ] GitHub OAuth設定が正しい
- [ ] Personal Access Tokenを保存した
- [ ] DBにデータが投入されている

## トラブルシューティング

### Terraform applyが失敗する

**AMI ID エラー**:
```
Error: creating EC2 Instance: ... InvalidAMIID.NotFound
```

**解決方法**: AMI IDは自動取得されるため、通常は発生しません。エラーが出る場合は `terraform init` を再実行してください。

### EC2に接続できない

**エラー**: "Failed to connect to your instance"

**解決方法**:
- Security Groupのポート22が開いているか確認
- インスタンスが起動しているか確認（数分待つ）

### Gitクローンが失敗する

**エラー**: "Authentication failed"

**解決方法**:
- Personal Access Tokenが正しいか確認
- トークンのスコープに `repo` が含まれているか確認

### Woodpecker UIにアクセスできない

**エラー**: ページが開かない

**解決方法**:
- Security Groupのポート8000が開いているか確認
- EC2のPublic IPが正しいか確認
- `docker ps` でコンテナが起動しているか確認

### パイプラインが失敗する

**setup-db失敗**:
- Aurora DBが起動しているか確認（0.0 ACUの場合15-30秒待つ）
- Security Group（EC2→Aurora: ポート5432）を確認

**test失敗**:
- API Gateway URLが正しいか確認
- `.woodpecker.yml` の環境変数を確認

## 次のステップ

再構築が完了したら、以下のドキュメントを参照して検証を進めてください：

- **07_動作確認テスト.md** - 基本的な動作確認
- **08_Venom検証テスト.md** - Venomを使った統合テスト

## 参考資料

- `01_Woodpecker検証プラン.md` - 検証の全体像
- `02_AWS環境設計.md` - インフラ設計詳細
- `03_EC2接続手順.md` - EC2接続の詳細手順
- `04_venom構築.md` - Venom構築の詳細
- `06_GitHubリポジトリ作成.md` - GitHub設定の詳細
- `09_クリーンアップ手順.md` - 削除手順

## まとめ

この再構築手順により、以下が完了します：

✅ AWS環境の再構築（Terraform）
✅ EC2への接続とセットアップ
✅ Woodpeckerの構築と起動
✅ パイプラインの動作確認

約30-45分で検証環境を再構築できます。
