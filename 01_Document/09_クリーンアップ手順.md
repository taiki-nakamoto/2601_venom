# クリーンアップ手順

## 概要

検証完了後、AWS環境のクリーンアップを行います。このドキュメントでは、安全にリソースを削除する手順を説明します。

**重要**: クリーンアップを実行すると、**すべてのAWSリソースが削除されます**。必要なデータは事前に保存してください。

## クリーンアップ前の確認

### ステップ1: 成果物の保存確認

以下のデータが保存されていることを確認してください：

**必須の保存データ**:
- [ ] Terraform出力結果（woodpecker_public_ip, db_endpoint, api_gateway_url）
- [ ] Woodpecker UIのスクリーンショット
  - [ ] パイプライン成功画面
  - [ ] setup-dbステップのログ
  - [ ] testステップのログ
- [ ] DBデータの確認結果（SELECT結果）
- [ ] API Gatewayのレスポンス例

**推奨の保存データ**:
- [ ] 検証レポート（`03_Research/YYYYMMDD_01_検証結果レポート.md`）
- [ ] 発生した問題と解決方法のメモ
- [ ] 所感・改善点

### ステップ2: GitHubリポジトリの確認

ローカルの変更がすべてGitHubにpushされていることを確認：

```bash
cd /home/naka/claude_code/2601_venom

# リポジトリの状態確認
git status

# 未コミットの変更がある場合
git add .
git commit -m "Add verification results and documentation"
git push origin main
```

**チェック項目**:
- [ ] `git status` で "working tree clean" と表示される
- [ ] すべてのドキュメントがGitHubにpush済み
- [ ] 検証結果がGitHubに保存されている

### ステップ3: 重要なファイルのバックアップ

以下のファイルをローカルPCにダウンロード（オプション）：

```bash
# EC2からローカルPCへ（別のターミナルで実行）
# secrets.txtは機密情報のため、必要に応じて
scp -i <key.pem> ec2-user@<EC2-IP>:~/2601_venom/src/secrets.txt ./
```

**注意**: `secrets.txt`にはPersonal Access Tokenが含まれているため、取り扱いに注意してください。

## クリーンアップ実行

### ステップ4: Woodpeckerの停止（EC2上）

EC2上でWoodpeckerコンテナを停止します（オプション、Terraform destroyで削除されるため）。

```bash
# EC2にSSH接続
cd ~/woodpecker-test

# Woodpeckerコンテナを停止
docker-compose down

# コンテナが停止したことを確認
docker ps
```

**チェック項目**:
- [ ] `docker ps` で Woodpeckerコンテナが表示されない

### ステップ5: Terraform Destroy実行

**重要**: この操作は取り消せません。すべての確認が完了してから実行してください。

```bash
# ローカルPC（Terraformを実行した環境）で実行
cd /home/naka/claude_code/2601_venom/src/terraform

# 削除されるリソースの確認
terraform plan -destroy

# リソースの削除実行
terraform destroy
```

**実行時のプロンプト**:
```
Do you really want to destroy all resources?
  Terraform will destroy all your managed infrastructure, as shown above.
  There is no undo. Only 'yes' will be accepted to confirm.

  Enter a value:
```

**`yes` と入力してEnter**を押します。

### ステップ6: 削除の進行確認

Terraformが以下のリソースを順番に削除します（約5-10分）：

**削除されるリソース**:
1. API Gateway（woodpecker-mock-api）
   - ステージ（dev）
   - デプロイメント
   - リソース、メソッド、統合
2. EC2インスタンス（woodpecker-server）
3. Elastic IP
4. Aurora Serverless v2
   - クラスターインスタンス
   - クラスター
   - サブネットグループ
5. Security Group
   - woodpecker-ec2-sg
   - woodpecker-db-sg
6. VPC関連
   - ルートテーブル
   - サブネット（Public, Private x2）
   - Internet Gateway
   - VPC

**進行状況の確認**:
```
aws_api_gateway_stage.dev: Destroying... [id=xxx]
aws_api_gateway_deployment.deployment: Destroying... [id=xxx]
aws_instance.woodpecker_server: Destroying... [id=i-xxx]
aws_rds_cluster_instance.postgresql_instance: Destroying... [id=xxx]
...
```

**完了メッセージ**:
```
Destroy complete! Resources: XX destroyed.
```

**チェック項目**:
- [ ] エラーなく完了した
- [ ] "Destroy complete!" が表示された

## クリーンアップ後の確認

### ステップ7: AWS Consoleでの確認

AWS Console（ap-northeast-1リージョン）で以下が削除されていることを確認：

**EC2**:
- [ ] `woodpecker-server` インスタンスが存在しない
- [ ] Elastic IPが存在しない

**RDS**:
- [ ] `woodpecker-db-cluster` が存在しない

**VPC**:
- [ ] `woodpecker-test-vpc` が存在しない

**API Gateway**:
- [ ] `woodpecker-mock-api` が存在しない

**Security Group**:
- [ ] `woodpecker-ec2-sg` が存在しない
- [ ] `woodpecker-db-sg` が存在しない

### ステップ8: コスト確認

AWS Billing & Cost Managementで以下を確認：

1. **Cost Explorer** を開く
2. 検証期間（今日または過去7日間）のコストを確認
3. 主なコスト項目:
   - EC2: t3.medium（~$0.05/時間）
   - Aurora Serverless v2: 0.0-1.0 ACU（使用時のみ課金）
   - API Gateway: リクエスト数に応じて
   - データ転送: 少額

**想定コスト**（数時間の検証）:
- 合計: $1-5程度（検証時間により変動）

### ステップ9: Terraformステートファイルのクリーンアップ

リソース削除後、Terraformステートファイルは不要になります。

```bash
cd /home/naka/claude_code/2601_venom/src/terraform

# ステートファイルの確認
ls -la

# ステートファイルの削除（オプション）
rm -f terraform.tfstate
rm -f terraform.tfstate.backup

# .terraformディレクトリの削除（オプション）
rm -rf .terraform
```

**チェック項目**:
- [ ] `terraform.tfstate` を削除した（またはバックアップ）
- [ ] `.terraform/` ディレクトリを削除した

**注意**: これらのファイルは `.gitignore` で除外されているため、Gitリポジトリには含まれていません。

## GitHubリポジトリの保持

### ステップ10: リポジトリの保持確認

**重要**: GitHubリポジトリは削除しません。以下の理由で保持します：

- ドキュメントが保存されている
- 将来の参照用
- 他のプロジェクトへの再利用
- 検証結果の記録

**保持されるもの**:
- すべてのドキュメント（01_Document/）
- タスク管理（02_Tasks/）
- 検証レポート（03_Research/）
- Terraformコード（src/terraform/）
- Woodpecker設定（src/.woodpecker.yml）
- SQLファイル（src/sql/）
- Venomテスト（src/tests/）

### ステップ11: リポジトリのアーカイブ（オプション）

検証が完全に終了した場合、リポジトリをアーカイブできます：

1. GitHub → リポジトリ → Settings
2. 下にスクロールして「Danger Zone」
3. 「Archive this repository」をクリック
4. 確認メッセージで `<username>/<repository>` を入力

**アーカイブの効果**:
- リポジトリが読み取り専用になる
- 新しいコミット、イシュー、プルリクエストができなくなる
- いつでもアンアーカイブ可能

**チェック項目**:
- [ ] リポジトリをアーカイブした（または保持）

## トラブルシューティング

### エラー: リソースが削除できない

**依存関係エラー**:
```
Error: Error deleting VPC: DependencyViolation: The vpc 'vpc-xxx' has dependencies and cannot be deleted
```

**原因**: 他のリソースがVPCに依存している

**解決方法**:
1. AWS Consoleで該当VPCを確認
2. 依存しているリソースを手動で削除
3. 再度 `terraform destroy` を実行

**一般的な依存リソース**:
- ENI（Elastic Network Interface）
- Lambda（VPC Lambda）
- RDS（削除保護が有効な場合）

### エラー: Aurora削除に時間がかかる

Auroraクラスターの削除には5-10分かかることがあります。

**確認方法**:
```bash
# 進行状況を確認
terraform show
```

または AWS Console → RDS でステータスを確認

### エラー: Elastic IPが削除できない

**原因**: EC2インスタンスと関連付けられている

**解決方法**:
1. EC2 Consoleで該当Elastic IPを確認
2. 「アソシエーションの解除」
3. 「Elastic IPアドレスの解放」

## クリーンアップ完了チェックリスト

### 必須項目
- [ ] 成果物をすべて保存した
- [ ] GitHubにすべての変更をpushした
- [ ] `terraform destroy` を実行した
- [ ] AWS Consoleですべてのリソースが削除されたことを確認した

### 推奨項目
- [ ] 検証レポートを作成した
- [ ] コストを確認した
- [ ] Terraformステートファイルを削除した
- [ ] リポジトリをアーカイブした（必要に応じて）

### 最終確認
- [ ] AWSに不要なリソースが残っていない
- [ ] GitHubリポジトリが保持されている
- [ ] ドキュメントがすべて保存されている

## 次のステップ

クリーンアップが完了したら、以下を検討してください：

1. **検証レポートの共有**
   - チームメンバーと共有
   - ブログ記事として公開
   - 社内wikiに記録

2. **改善案の実装**
   - Lambda統合への移行
   - セキュリティ強化
   - 本番環境への適用

3. **再検証**
   - 必要に応じて `terraform apply` で再度環境を構築可能
   - ドキュメントとコードがGitHubに保存されているため、いつでも再現可能

## 参考資料

- `02_AWS環境設計.md` - 構築したリソースの詳細
- `07_動作確認テスト.md` - 基本編の手順
- `08_Venom検証テスト.md` - 応用編の手順
- [Terraform Destroy Documentation](https://www.terraform.io/docs/commands/destroy.html)
- [AWS Cost Explorer](https://aws.amazon.com/aws-cost-management/aws-cost-explorer/)

お疲れ様でした！
