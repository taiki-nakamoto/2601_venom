# 動作確認テスト（基本編）

## 概要

このドキュメントでは、Woodpecker CI環境の基本的な構築確認を行います。

**確認範囲**:
- AWS環境の構築
- EC2への接続
- Woodpeckerの起動

**次のステップ**: Venomを使った統合テストは「08_Venom検証テスト.md」を参照してください。

## テスト実施前の準備

### 必要な情報

以下の情報を事前に準備してください：

- [ ] EC2 Public IP（Terraform出力から取得）
- [ ] Aurora Endpoint（Terraform出力から取得）
- [ ] API Gateway URL（Terraform出力から取得）
- [ ] GitHub Client ID
- [ ] GitHub Client Secret
- [ ] GitHub Personal Access Token

## フェーズ1: インフラ構築確認

### 1.1 Terraform実行確認

**目的**: AWS環境が正しく構築されたことを確認

```bash
cd /home/naka/claude_code/2601_venom/src/terraform
terraform output
```

**チェック項目**:
- [ ] `woodpecker_public_ip` が出力されている
- [ ] `db_endpoint` が出力されている（woodpecker-db-cluster.cluster-xxx.ap-northeast-1.rds.amazonaws.com）
- [ ] `api_gateway_url` が出力されている（https://xxx.execute-api.ap-northeast-1.amazonaws.com/dev/users）
- [ ] `ami_id` が出力されている

**出力例**:
```
woodpecker_public_ip = "54.xxx.xxx.xxx"
db_endpoint = "woodpecker-db-cluster.cluster-xxx.ap-northeast-1.rds.amazonaws.com"
api_gateway_url = "https://xxxxxx.execute-api.ap-northeast-1.amazonaws.com/dev/users"
ami_id = "ami-xxxxxxxxx"
```

**トラブルシューティング**:
- 出力が表示されない → `terraform apply` が正常に完了したか確認
- エラーが表示される → `terraform plan` でエラー内容を確認

### 1.2 AWS Console確認

**目的**: リソースがAWS Console上で確認できることを確認

**チェック項目**:
- [ ] VPC: `woodpecker-test-vpc` が作成されている
- [ ] EC2: `woodpecker-server` インスタンスが **running** 状態
- [ ] RDS: `woodpecker-db-cluster` が **available** 状態
- [ ] API Gateway: `woodpecker-mock-api` が作成されている
- [ ] Security Group:
  - [ ] `woodpecker-ec2-sg` にポート22, 8000のインバウンドルール
  - [ ] `woodpecker-db-sg` にポート5432のインバウンドルール

**トラブルシューティング**:
- Auroraが **creating** 状態 → 10-15分待つ（0.0 ACUからの起動は時間がかかる）
- EC2が起動しない → EC2コンソールでシステムログを確認

## フェーズ2: EC2接続確認

### 2.1 EC2 Instance Connect接続

**目的**: EC2に正常に接続できることを確認

**手順**:
1. AWS Console → EC2 → インスタンス → `woodpecker-server` を選択
2. 「接続」ボタンをクリック
3. 「EC2 Instance Connect」タブを選択
4. ユーザー名: `ec2-user`
5. 「接続」をクリック

**チェック項目**:
- [ ] ブラウザでターミナル画面が開く
- [ ] プロンプトが表示される（`[ec2-user@ip-xxx ~]$`）

**トラブルシューティング**:
- "Failed to connect" エラー → Security Groupのポート22が開いているか確認
- タイムアウト → インスタンスが起動しているか、Public IPが割り当てられているか確認

### 2.2 Docker/Docker Compose確認

**目的**: Dockerが正しくインストールされていることを確認

```bash
# Dockerバージョン確認
docker --version

# Docker Composeバージョン確認
docker-compose --version

# Dockerサービス状態確認
sudo systemctl status docker
```

**チェック項目**:
- [ ] `Docker version 20.x.x` 以上が表示される
- [ ] `docker-compose version 1.x.x` または `Docker Compose version v2.x.x` が表示される
- [ ] Dockerサービスが **active (running)** 状態

**トラブルシューティング**:
- コマンドが見つからない → user_dataの実行が完了していない可能性（数分待つ）
- 確認方法: `sudo cat /var/log/cloud-init-output.log | tail -50`

### 2.3 Git確認とリポジトリクローン

**目的**: Gitがインストールされ、リポジトリをクローンできることを確認

```bash
# Gitバージョン確認（インストールされていない場合）
git --version

# インストールされていない場合
sudo dnf install -y git

# リポジトリをクローン
cd ~
git clone https://github.com/taiki-nakamoto/2601_venom.git
```

**認証情報の入力**:

プライベートリポジトリの場合、以下のように認証が求められます：

```
Username for 'https://github.com': taiki-nakamoto
Password for 'https://taiki-nakamoto@github.com':
```

**入力方法**:
1. **Username**: GitHubのユーザー名（`taiki-nakamoto`）を入力
2. **Password**: 先ほど発行した **Personal Access Token（トークン）を貼り付け** ます
   - ⚠️ 画面には何も表示されませんが、貼り付けられています
   - パスワードではなく、トークン（`ghp_xxx...`）を入力してください

**クローン後の確認**:

```bash
# ディレクトリに移動
cd 2601_venom
ls -la
```

**チェック項目**:
- [ ] `git --version` でバージョンが表示される
- [ ] 認証情報を正しく入力した
- [ ] リポジトリが正常にクローンされる
- [ ] `src/`, `01_Document/`, `02_Tasks/` 等のディレクトリが確認できる

**トラブルシューティング**:
- "Authentication failed" → Personal Access Tokenが正しいか確認（`repo` スコープが必要）
- "repository not found" → リポジトリ名、ユーザー名が正しいか確認

### 2.4 GitHub Personal Access Token（PAT）の発行

**目的**: EC2からGitHubへpushするための認証トークンを取得

EC2からGitHubにpushする際に、Personal Access Token（PAT）が必要です。以下の手順で発行してください。

**手順**:

1. **GitHubにログイン**し、右上のアイコンから **Settings** を開きます

2. 左メニューの一番下 **Developer settings** ＞ **Personal access tokens** ＞ **Tokens (classic)** を選択します

3. **Generate new token** ＞ **Generate new token (classic)** をクリックします

4. トークンの設定:
   - **Note**: 「EC2-Test」など適当な名前を付けます
   - **Expiration**: 期限は「7 days」など短くてOKです
   - **Select scopes**: `repo` にチェックを入れます（リポジトリの読み書き権限）

5. 一番下の **Generate token** をクリックし、表示された文字列を **必ずコピー** してください

   ⚠️ **重要**: 一度閉じると二度と表示されません

**トークンの保存**:

```bash
# EC2上でトークンをsecrets.txtに保存（.gitignoreで除外済み）
cd ~/2601_venom/src
echo "GITHUB_TOKEN=ghp_xxxxxxxxxxxxxxxxxxxx" > secrets.txt

# 権限を自分だけに制限
chmod 600 secrets.txt
```

**チェック項目**:
- [ ] Personal Access Tokenを発行した
- [ ] トークンをコピーした
- [ ] secrets.txtに保存した

## フェーズ3: Woodpecker構築確認

### 3.1 setup.sh実行

```bash
cd ~/2601_venom/src
chmod +x setup.sh
./setup.sh
```

**入力が必要な情報**:
- EC2 Public IP: `<Terraform出力から>`
- GitHub Client ID: `<GitHubから取得>`
- GitHub Client Secret: `<GitHubから取得>`
- Aurora Endpoint: `<Terraform出力から>`
- API Gateway URL: `<Terraform出力から>`

**チェック項目**:
- [ ] docker-compose.ymlが作成される
- [ ] .woodpecker.ymlが作成される
- [ ] tests/api_db_test.venom.ymlが作成される
- [ ] Woodpeckerが起動する（`Starting Woodpecker...`）

### 3.2 Woodpecker UI確認

ブラウザで以下にアクセス:
```
http://<EC2 Public IP>:8000
```

**チェック項目**:
- [ ] Woodpecker UIが表示される
- [ ] 「Login with GitHub」ボタンが表示される
- [ ] GitHubでログインできる
- [ ] リポジトリ一覧が表示される

**トラブルシューティング**:
- ページが開かない → Security Groupのポート8000を確認、EC2のPublic IPが正しいか確認
- ログインできない → GitHub OAuth設定（Callback URL）を確認
- リポジトリが表示されない → GitHubでWoodpeckerアプリの権限を確認

### 3.3 Docker起動確認

```bash
# Dockerコンテナ確認
docker ps

# ログ確認
docker-compose logs woodpecker-server
docker-compose logs woodpecker-agent
```

**チェック項目**:
- [ ] `woodpecker-server` コンテナが起動している（Up）
- [ ] `woodpecker-agent` コンテナが起動している（Up）
- [ ] ログにエラーが出ていない

**トラブルシューティング**:
- コンテナが起動していない → `docker-compose up -d` を再実行
- ポートが使用中 → `sudo lsof -i :8000` で確認

### 3.4 Woodpeckerでリポジトリ有効化

1. Woodpecker UI → リポジトリ一覧
2. `2601_venom` リポジトリを探す
3. 「Enable」をクリック

**チェック項目**:
- [ ] リポジトリが有効化される
- [ ] リポジトリの設定画面が表示される

## 基本編完了チェックリスト

- [ ] フェーズ1: インフラ構築確認 → すべてクリア
- [ ] フェーズ2: EC2接続確認 → すべてクリア
- [ ] フェーズ3: Woodpecker構築確認 → すべてクリア

## 次のステップ

基本編が完了したら、**08_Venom検証テスト.md** に進んでください。

Venom検証テストでは以下を実施します：
- DB接続テスト（Venom経由）
- API Gateway確認（Venom経由）
- 統合テスト
- エンドツーエンド検証

## 参考資料

- `01_Woodpecker検証プラン.md` - 検証の全体像
- `02_AWS環境設計.md` - インフラ設計
- `03_EC2接続手順.md` - EC2接続方法
- `04_venom構築.md` - Venom構築手順
- `06_GitHubリポジトリ作成.md` - GitHubリポジトリ作成手順
- `08_Venom検証テスト.md` - Venom統合テスト（次のステップ）
